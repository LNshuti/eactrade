---
title: "README"
output: html_document
---

```{r setup, include=FALSE}
source("R/manifest.R")
```

```{r}
countries_codes <- 
  read_csv("processed/rwa_sum_features.csv")

# Location corresponds to the importing entity(receiving country)
# Partner_id corresponds to the exporting entity
# Product ID is a unique identifier from the Harvard Wits database
dfeac_productname_partner_id <- 
  read_rds("data/processed/eac_trade_df_2015_2019.rds") %>%
  mutate(import_value = as.numeric(import_value), 
         export_value = as.numeric(export_value)) %>%
  select(from, to, 
         #product_id,
         year, import_value, export_value) %>%
  group_by(from, to) %>%
  summarise(imports = sum(import_value, na.rm = TRUE), 
            exports = sum(export_value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(trade_bal = abs(exports- imports)) %>%
  unique() 

countries_of_inter <- 
  dfeac_productname_partner_id %>% 
  select(from, to) %>% 
  unique()

countries_v <-
  c(countries_of_inter$from, countries_of_inter$to) %>% 
  unique()

countries_xw <- 
  read_csv("data/countries_codes_and_coordinates.csv") %>% 
  janitor::clean_names() %>%
  select(country_code = alpha_3_code, country)  %>% 
  filter(country_code %in% countries_v)

```


```{r}
set.seed(123987)
eac_tradebal_df <-  
  dfeac_productname_partner_id %>%
  select(from, to,  trade_bal) %>%
  mutate_at(.vars = c("to", "from"), as.factor)

eac_tradebal_bp <-  
  eac_tradebal_df %>%
  spread(from, trade_bal) %>%
  convert_to_bipartite(id = to) 

eac_tradebal_bp[is.na(eac_tradebal_bp)] <- 0

net_bp <- 
  graph_from_incidence_matrix(eac_tradebal_bp,weighted=TRUE) %>% 
  igraph::simplify(., remove.loops=TRUE) %>% 
  as_tbl_graph() %>%
  activate(nodes) %>%
  as_tibble() %>%
  left_join(eac_tradebal_df,by = c("name" = "to")) %>%
  filter(type == TRUE) %>%
  select(-type)

# Not specifying the layout - defaults to "auto"
unweighted_graph <- 
  graph_from_data_frame(net_bp) %>% 
  ggraph(layout='lgl') +
  geom_edge_link(alpha = .25, 
                 aes(width = trade_bal), show.legend = FALSE) +
  geom_node_point() +
  geom_node_text(aes(label = name), repel = TRUE) +
  theme(legend.position = "none")  

ggsave(unweighted_graph,
       filename = "output/unweighted_graph.png",
       width = 3, height = 3)


```
