---
title: "README"
output: html_document
---

```{r setup, include=FALSE}
repo_ <- "eactrade"
source(paste0(repo_, "/R/manifest.R"))
```

```{r}
# Location corresponds to the importing entity(receiving country)
# Partner_id corresponds to the exporting entity
# Product ID is a unique identifier from the Harvard Wits database
dfeac_productname_partner_id <- 
  read_rds("eactrade/data/processed/eac_trade_df_2015_2019.rds") %>%
  mutate(import_value = as.numeric(import_value), 
         export_value = as.numeric(export_value)#,
         #location_product = paste0(location_id,"_", product_id)# ,
         #partner_year = paste0(partner_id, "_", year)
         ) %>%
  select(from, to, product_id, year, import_value, export_value) %>%
  #select(location_product, partner_year, import_value, export_value) %>%
  group_by(from, to, product_id) %>%
  summarise(imports = sum(import_value, na.rm = TRUE), 
            exports = sum(export_value, na.rm = TRUE)) %>%
  ungroup() %>%
  #mutate(trade_bal = exports- imports) %>%
  unique() 
```


```{r}
library(igraph)
library(graphlayouts)
library(gridExtra)

set.seed(123987)
eac_tradebal_bp <-  
  dfeac_productname_partner_id %>%
  filter(exports > 0 & imports > 0) %>%
  mutate(product_origin = paste0(from, "_", product_id)) %>%
  select(product_origin, to,  imports) %>%
  spread(product_origin, imports) %>%
  convert_to_bipartite(id = to) 

eac_tradebal_bp[is.na(eac_tradebal_bp)] <- 0

net_bp <- 
  graph_from_incidence_matrix(eac_tradebal_bp,weighted=TRUE) %>% 
  igraph::simplify(., remove.loops=TRUE) %>% 
  as_tbl_graph() %>%
  activate(nodes) %>% 
  left_join(xy_hosp %>% 
              select(name = prvnumgrp,mname),"name") %>% 
  mutate(label = ifelse(!is.na(mname),mname,name))

unweighted_graph <- 
  ggraph(net_bp, layout='lgl') +
  geom_edge_link(aes(width = weight,alpha=weight),show.legend = FALSE) + 
  geom_node_point(aes(colour=type), cex = 6) +
  geom_node_text(aes(label = label),cex = 3) +
  #remove_all_axes  + 
  theme(legend.position = "none")  

# ggsave(unweighted_graph,
#        filename = paste0(repo_, "/outputs/unweighted_graph.png"), 
#        width = 4, height = 4)

countries_xw <- 
  read_csv(paste0(repo_, "/data/countries_codes_and_coordinates.csv")) %>% 
  janitor::clean_names() %>%
  select(country_code = alpha_3_code, country) %>%
  filter(country_code %in% c("COM", "AGO", "ERI", "BWA", "CPV", "CAF", 
                             "CMR", "GNQ", "TCD", "ETH", "COD")) 
combined_plt <- 
  grid.arrange(unweighted_graph,
               tableGrob(countries_xw, rows = NULL), 
               heights=c(2, 0.3), nrow=2)

dev.off()

ggsave(combined_plt,
       filename = paste0(repo_, "/output/combined_plt.png"),
       width = 8, height = 10)
```



```{r, fig.cap = "Visualization of ZIP-Hospital Patient Flows as a Bipartite Network Object", fig.width = 8, fig.height=8,fig.pos="H", echo = FALSE}
set.seed(1)
net_bp %>% 
  ggraph(layout='lgl') + 
  #scale_x_continuous(limits = c(-15,10)) + 
  #scale_y_continuous(limits = c(-20,6)) +
  geom_edge_link(aes(width = weight,alpha=weight),show.legend = FALSE) + 
  geom_node_point(aes(colour=type), cex = 6) +
  geom_node_text(aes(label = label),cex = 3) +
  remove_all_axes  + 
  theme(legend.position = "none")  
```
