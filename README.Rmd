---
title: "README"
output: html_document
---

```{r setup, include=FALSE}
repo_ <- "eactrade"
source(paste0(repo_, "/R/manifest.R"))
```

```{r}
# Location corresponds to the importing entity(receiving country)
# Partner_id corresponds to the exporting entity
# Product ID is a unique identifier from the Harvard Wits database

dfeac_productname_partner_id <- 
  read_rds("eactrade/data/processed/eac_trade_df_2015_2019.rds") %>%
  filter(location_id != partner_id & year == "2019") %>%
  mutate(import_value = as.numeric(import_value), 
         export_value = as.numeric(export_value),
         location_product = paste0(location_id,"_", product_id)# ,
         #partner_year = paste0(partner_id, "_", year)
         ) %>%
  sample_n(5) %>% 
  select(location_product, partner_id, year, import_value, export_value) %>%
  #select(location_product, partner_year, import_value, export_value) %>%
  group_by(location_product, partner_id) %>%
  summarise(imports = sum(import_value, na.rm = TRUE), 
            exports = sum(export_value, na.rm = TRUE)) %>%
  
  ungroup() %>%
  mutate(trade_bal = exports- imports) %>%
  unique()
  
eac_tradebal_bp <-  
  dfeac_productname_partner_id %>%
  select(location_product, partner_id, weight = trade_bal) %>%
  as_tbl_graph()
  # pivot_wider(id_cols = location_product,
  #             names_from = partner_id, 
  #             values_from = c("weight")) %>%
  # convert_to_bipartite(id = location_product)

ggraph(eac_tradebal_bp, layout = 'kk') + 
  #geom_edge_link(aes(colour = factor(year))) + 
  geom_node_point() %>%


eac_exports_bp <-  
  dfeac_productname_partner_id %>%
   select(location_product, partner_id, exports) %>%
  pivot_wider(id_cols = location_product,
              names_from = partner_id, 
              values_from = c("exports")) %>%
  convert_to_bipartite(id = location_product)

eac_imports_bp[is.na(eac_imports_bp)] <- 0

eac_imports_up <-eac_imports_bp %*% t(eac_imports_bp)

nodes_eac_products <-
  as_tbl_graph(eac_imports_up) 

```


```{r}
ggraph_df <- 
  dfeac_productname_partner_id %>% 
  select(-exports) %>%
  graph_from_data_frame(.)

ggraph(ggraph_df, layout = 'fr', weights = "weight") + 
  geom_edge_link() + 
  geom_node_point()


g1 <- graph.adjacency(cor1$r, weighted=TRUE, mode="lower")
g1 <- delete.edges(g1, E(g1)[ abs(weight) < 0.3 ])
plot.igraph(g1, vertex.size=20, edge.width=abs(E(g1)$weight)*8, 
        edge.color=ifelse(cor1$r > 0, "blue","red"))
```
